<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">

<!-- $Id$ -->

<HEAD>
<TITLE>Maintaining and updating configure.in and Makefile.in</TITLE>
</HEAD>

<BODY BGCOLOR="#ffffff">

<DIV ALIGN="CENTER">
<H1>Working with <TT>configure.in</TT> and <TT>Makefile.in</TT></H1>
</DIV>

<HR WIDTH="80%" NOSHADE>

<H2>Basics</H2>

<DL>
  <DT><B>Comments in <TT>configure.in</TT></B>
    <DD>
      <P>

      Two types of comments can be used in <TT>configure.in</TT>.  The first
      is the relatively standard ``<TT>#</TT>'' comment.  Lines beginning
      with this character are copied into the final <I>configure</I> script
      generated by <I>autoconf</I>(1).  The other type is the <I>m4</I>(1)
      comment.  Lines commented in this way begin with ``<TT>dnl</TT>'' and
      are <I>not</I> copied into the <I>configure</I> script.

      <P>
  <DT><B>Language used in <TT>configure.in</TT></B>
    <DD>
      <P>

      The scripting language used in <TT>configure.in</TT> is <I>sh</I>(1).
      All conditional statements must use the form:

<PRE>
    if test "$some_var" = "some_val" ; then
        ...
    fi
</PRE>

      rather than:

<PRE>
    if [ "$some_var" = "some_val" ] ; then
        ...
    fi
</PRE>

      The brackets are recognized as special characters by <I>m4</I>(1) and
      may not be copied into <I>configure</I> properly.

      <P>
  <DT><B>Multi-line parameters to Autoconf macros</B>
    <DD>
      <P>

      Parameters spanning multiple lines may be passed to Autoconf macros
      without using backslashes through a special block recognized by
      <I>m4</I>(1).  Simply enclose the parameter in <TT>[]</TT>'s and it
      will be parsed as one parameter.  Remember to be careful about the use
      of semi-colons for separating <I>sh</I>(1) statements within these
      blocks.

      <P>
  <DT><B>Custom preprocessor information</B>
    <DD>
      <P>

      Anything that defines preprocessor macros other than those generated
      by the Autoconf macros must be defined in <TT>acconfig.h</TT>.  If they
      are not defined in this file, <I>autoheader</I>(1) will complain as it
      parses <TT>configure.in</TT> and finds these customizations.  Follow
      the existing syntax and layout of <TT>acconfig.h</TT> when making
      additions to it.  In general, additions only have to be made when a new
      <I>AC_DEFINE</I>, <I>AC_CHECK_TYPE</I>, etc. line is added to
      <TT>configure.in</TT>.

      <P>
  <DT><B>Including a common, external <TT>Makefile</TT></B>
    <DD>
      <P>

      Due to inconsistencies in the way various operating systems implement
      some sort of ``include'' directive in their <I>make</I>(1), there is no
      easy method for including a common, external <TT>Makefile</TT>
      containing variable assignments common to all <TT>Makefile</TT>s in the
      source tree such that it would be platform independent.  The result of
      this is a lot of redundancy in the <TT>Makefile.in</TT> files.  The use
      of GNU's version of <I>make</I>(1) on all build platforms may or may
      not simplify this issue.
</DL>

<HR WIDTH="80%" NOSHADE>
<P>

<H2>Layout of <TT>configure.in</TT></H2>

<DL>
  <DT><B>Initialization</B>
    <DD>
      <P>

      The first short block of <TT>configure.in</TT> performs some very basic
      initialization tasks.  The RCS revision number of the script is
      maintained here so that the user can verify that s/he has the most
      recent version of the actual <I>configure</I> script.  A check for one
      file in the source tree is also made to perform a very general, inexact
      verification that things are where they are supposed to be.  Currently,
      <I>configure</I> will check for the existence of
      <TT>Config/vjChunkDesc.cpp</TT>.  Finally, the header file created when
      done with the configuration process is named.  This file is called
      <TT>vjDefines.h</TT>.

      <P>
  <DT><B>Custom arguments</B>
    <DD>
      <P>

      In this block, the custom arguments for the <I>configure</I> script are
      defined.  The first set defines the
      <TT>--with-<I>package</I>[=<I>arg</I>]</TT> and
      <TT>--without-<I>package</I></TT> arguments.  These are intended to be
      used for choosing some external software package to use at compile
      time.  They are also used for providing a small level of customization
      to how the external software is found and/or used.

      <P>

      The second set define the <TT>--enable-<I>feature</I>[=<I>arg</I>]</TT>
      and <TT>--disable-<I>feature</I></TT> arguments that allow the user
      to choose which optional features can be built.  From the Autoconf
      2.12 documentation, ``These options should never make a feature behave
      differently or cause one feature to replace another.''

      <P>

      For both sets of options, the <I>AC_ARG_WITH</I> and
      <I>AC_ARG_ENABLE</I> macros behave the same way.  The first argument is
      the package/feature, the second is the description printed when the
      user runs <I>configure</I> with the ``<TT>--help</TT>'' option.  The
      third argument sets a user-defined variable in the script to the
      contents of <TT>$withval</TT> or <TT>$enableval</TT> respectively.  If
      no argument is given (e.g., the user specified
      ``<TT>--enable-opengl</TT>''), the variable will get either ``yes'' or
      ``no'' as its value depending upon whether the user used the positive
      or negative form of the argument.

      <P>
  <DT><B>System-dependent setup</B>
    <DD>
      <P>

      Here, a common set of script variables are given values that are
      usually dependent upon the system on which the script is being run.
      The new variables used are all set to have no value before the
      conditional <TT>case</TT> block begins.  The subsequent conditional
      block compares the value in <TT>$host</TT> (obtained from the
      <I>AC_CANONICAL_HOST</I> macro) with known systems and sets values for
      the variables appropriately.

      <P>

      Some existing variables are modified here as well.  These include
      <TT>$CFLAGS</TT>, <TT>$CXXFLAGS</TT> and <TT>$INCLUDES</TT>.  Each of
      these could have been set as part of the user's environment variables
      or previously in the script as part of executing a macro.  Thus, they
      should be treated carefully so as not to destroy any existing values
      that may be stored in them.

      <P>

      Besides setting values in variables, custom pre-processor macros are
      defined here using the <I>AC_DEFINE</I> macro.  This macro takes two
      parameters:

      <P>
      <OL>
	<LI>The name of the macro to define.
	<LI>The value to which the macro is set by the pre-processor.
      </OL>
      <P>

      To do something similar to:

<PRE>
  #define VJ_DEF
</PRE>

      use the following syntax:

<PRE>
  AC_DEFINE(VJ_DEF,)
</PRE>

      Defining macros that take parameters cannot be done with
      <I>AC_DEFINE</I>.  However, based on a check made for something (such
      as <I>sginap</I>(2)), such a macro can be defined at the bottom of
      <TT>acconfig.h</TT>.  Refer to this file to see how a macro for
      <I>sginap</I>() is defined using <I>usleep</I>(2) in this manner.

      <P>
  <DT><B>External program checks</B>
    <DD>
      <P>

      This block is for standard program checks that <I>configure</I> does
      to ensure that software needed for compiling the package works.  Using
      the values in several preset variables (including <TT>$CC</TT> for the
      C compiler and <TT>$CXX</TT> for the C++ compiler), it runs tests on
      the software and reports any problems it finds.

      <P>
  <DT><B>External library checks</B>
    <DD>
      <P>

      Checks for needed external libraries are made here.  In this
      <I>configure</I> script, a great deal of processing is done in order
      to ensure that the source can be properly compiled and linked using
      certain external libraries.  The basic process of checking for a
      library (say, the OpenGL library) involves first checking to see if
      the library can be linked, and if so, a check is then made for a
      standard header file associated with the library (in this case,
      <TT>GL/gl.h</TT>).  In some cases, if a library cannot be found, a
      fallback check is provided.  In the case of the POSIX threads library,
      an attempt to link against <TT>libpthread</TT> is made.  If that fails
      (as it will on HP-UX 10.20), a check is made to link against
      <TT>libcma</TT>.

      <P>

      Upon successfully finding a library and a needed header file, various
      variables are usually set that are used later in the Makefile
      generation phase.  This process tends to get complicated with the VR
      Juggler configuration process because some source is conditionally
      compiled in depending upon what is determined in this phase of
      processing.  This is addressed in more detail in the section about
      <TT>Makefile.in</TT> files.  If a library is not found, the script may
      simply issue a warning about the problem or it may exit altogether if
      the library's existence is crucial to the compiling process.

      <P>

      Adding new library checks can be complicated.  The best method is to
      refer to the Autoconf 2.12 documentation and the existing checks.  All
      follow basically the same structure.

      <P>
  <DT><B>Header file checks</B>
    <DD>
      <P>

      Checks for standard header files and user-specified header files are
      made here.  The user-specified list is a space-separated list of
      header files that may not exist on all systems.  If a header file is
      found, <TT>HAVE_<I>FILENAME</I>_H</TT> is defined in <TT>vjDefines.h</TT>
      when it is generated.

      <P>
  <DT><B><TT>typedef</TT>, <TT>struct</TT> and compiler characteristic
      checks</B>
    <DD>
      <P>

      Here, checks are made to determine if the host system has various
      types and structures defined or not.  There are a few existing macros
      that check for specific examples of these, and it is possible to have
      user-defined checks.  Currently, little is done in this block, and in
      fact the only user-specified check is to see if the host system has
      <TT>u_int</TT> defined.  If not, it defines it (via the preprocessor,
      not <TT><B>typedef</B></TT>) to be <TT>unsigned int</TT> through the
      <I>AC_CHECK_TYPE</I> macro.  To check for <TT>struct</TT>s, use
      <I>AC_TRY_COMPILE</I> or <I>AC_EGREP_CPP</I>.  Refer to the Autoconf
      2.12 documentation section on ``Existing Tests'' for more detailed
      information.

      <P>
  <DT><B>Library function checks</B>
    <DD>
      <P>

      Here, checks are made for any library and system functions (e.g.,
      <I>gettimeofday</I>(2), <I>socket</I>(2), <I>sginap</I>(2)) that may
      not exist on all systems.  As with other sections, the user-specified
      list of functions to check is the space-separated parameter passed to
      the <I>AC_CHECK_FUNCS</I> macro.  If found, <TT>HAVE_<I>FUNCNAME</I></TT>
      will be defined in <TT>vjDefines.h</TT>.

      <P>
  <DT><B>Makefile substitution</B>
    <DD>
      <P>

      Within this block of <TT>configure.in</TT>, special symbols in the
      <TT>Makefile.in</TT> files are slated for replacement with variable
      values.  This is done through the <I>AC_SUBST</I> macro, and it simply
      replaces a ``tag'' in a <TT>Makefile.in</TT> with the value stored in
      the corresponding <I>configure</I> script variable.  The following
      example illustrates what happens during the file generation phase
      (discussed next).

      Say that some <TT>Makefile.in</TT> contains the following line:

<PRE>
  CUSTOM_VAR = @CUSTOM_VAR@
</PRE>

      The string enclosed by <TT>@</TT>'s is the tag that will be replaced
      when <TT>Makefile</TT> is generated.  In <TT>configure.in</TT>, there
      following line must be present:

<PRE>
  AC_SUBST(CUSTOM_VAR)
</PRE>

      Note that the variable is not prepended by a `<TT>$</TT>' because
      variable interpolation should not be done here.  Of course,
      <TT>$CUSTOM_VAR</TT> will generally have had some value set prior to
      this point.  That is not required however.

      <P>

      It is in this phase of configuration that most of the system-dependent
      build work is done.  This is similar to what Imake template files do.
      Virtually everything preceding this point set variables to have values
      appropriate to the host machine, and now they are put into the
      <TT>Makefile</TT>s to be used for compiling the code.  There are
      several pre-defined variables that <I>configure</I> will substitute in
      the input template files.  Refer to the section titled ``Preset Output
      Variables'' in the Autuconf 2.12 documentation for a list of these.

      <P>
  <DT><B>File generation</B>
    <DD>
      <P>

      In this last block, file generation is performed using the
      <I>AC_OUTPUT</I> macro.  It iterates through its space-separated list
      of files and finds the associated <TT>.in</TT> template file.  In
      general, this step is only used for generating Makefiles
      (<TT>vjDefines.h</TT> is defined automatically due to the
      <I>AC_CONFIG_HEADER</I> call at the top of <TT>configure.in</TT>).
      When a new directory and corresponding <TT>Makefile.in</TT> are added
      to the source tree, an entry for it must be added to this list.
</DL>

<HR WIDTH="80%" NOSHADE>
<P>

<H2>General Layout of a <TT>Makefile.in</TT> file</H2>

<DL>
  <DT><B>Preset variables and variables local to the current file</B>
    <DD>
      <P>

      The first set of assignments is for preset variables (that is, those
      that are preset by <I>configure</I>) and for variables that are closely
      related to the preset variety.  In general, many of these variables will
      have values that are specific to the current <TT>Makefile</TT> being
      generated.  In other words, they cannot be shared via a common file
      that would be somehow included by the current <TT>Makefile</TT>.

      <P>
  <DT><B>System-dependent variables</B>
    <DD>
      <P>

      These variables are those that are dependent upon the host build system.
      They include paths to external programs, options passed to those
      programs, which C and C++ compilers to use, etc.  For the most part,
      these variables will have the same values among all <TT>Makefile</TT>s.

      <P>

      In every <TT>Makefile.in</TT>, <TT>$OBJDIR</TT> is set to ``<TT>.</TT>'',
      but this is overridden at compile time with a value set by the top-level
      <TT>Makefile</TT> that is passed as an argument to recursive
      <I>make</I>(1) calls.  Thus, the result is that when doing a full
      library build, all the object files are built in a common location.
      However, if a developer only wishes to compile files in a specific
      directory in the tree, the object files will be put in the current
      directory.

      <P>

      The <TT>${OPTIMIZER}</TT> variable is one that is set outside the
      generated <TT>Makefile</TT> by the top-level <TT>Makefile</TT> in its
      recursive calls to <I>make</I>(1).  It is used for compiling debugging
      and optimized versions of the library, and this is decided in the
      top-level <TT>Makefile</TT>.  When compiling only in a specific source
      directory, it can be overridden (as can all variables) on the command
      line.

      <P>

      The <TT>${VPATH}</TT> variable is a special one that tells <I>make</I>(1)
      where to find dependencies for object files when the source is in
      another directory.  This allows easy compiling of common source for
      multiple platforms independently.  This variable should be ``set'' to
      <TT>@srcdir@</TT> in <TT>Makefile.in</TT> rather than to
      <TT>${srcdir}</TT> because some implementations of <I>make</I>(1) may
      not handle the latter properly.

      <P>
  <DT><B>Compiler, source and object variables</B>
    <DD>
      <P>

      The first set in this group combines all the system-dependent variables
      related to the C and C++ compilers into <TT>${C_COMPILE}</TT> and
      <TT>${CXX_COMPILE}</TT> respectively.  These are then used in the build
      targets for compiling C and C++ code.

      <P>

      Next, the source files that <I>makedepend</I>(1) will parse are
      listed.  They are passed as arguments to this program when the
      <B>depend</B> target is built.  The file names should not have any path
      prepended to them because this will interfere with the output from
      <I>makedepend</I>(1).  When the <B>depend</B> target is built, it knows
      which directory contains the files to parse from the <TT>${srcdir}</TT>
      variable.

      <P>

      Finally, the object files to be built are listed.  Each object file
      should have <TT>${OBJDIR}</TT> prepended to it.  This is part of being
      able to build object files in a common directory or in the current
      directory depending on the context of the build.  The variable
      containing the list of object files is used as the dependency for the
      <B>all</B>, <B>dbg</B>, <B>opt</B>, <B>dso</B>, <B>ddso</B> and
      <B>obj</B> targets.

      <P>

      This is the first occurrence of conditionally compiled files.  Depending
      upon which platform the library is being built on and upon other factors
      (threading package, API, etc.), some files may need to be compiled while
      other do not (or cannot).  This is decided by <I>configure</I> when it
      is run, and then the Makefile substitution phase takes care of it in
      the generated <TT>Makefile</TT>s.  A simple example of how this is used
      can be found in <TT>SharedMem/Makefile.in</TT>.  For the dependency
      sources and the object files, the following is done:

<PRE>
  DEPEND_SRCS = vjMemory.C @SHAREDMEM_DEPEND_SRCS@

  SHM_OBJECTS = ${OBJDIR}/vjMemory.o @SHAREDMEM_OBJS@
</PRE>

      Any extra platform- or implementation-specific files are defined when
      <TT>@SHAREDMEM_DEPEND_SRCS@</TT> and <TT>@SHAREDMEM_OBJS@</TT> are
      expanded by <I>configure</I>.  Because these tags may sometimes be
      expanded to nothing, they should never be put on a separate line if
      the list is spanned across multiple lines with backslashes.  In such a
      case, it is usually easiest to append the tag to the last line.

      <P>
  <DT><B>Miscellaneous variables</B>
    <DD>
      <P>

      Depending on which <TT>Makefile.in</TT> is being examined, any extra
      variables needed are set here.  For example, in the top-level
      <TT>Makefile.in</TT>, the variables for the common build directory are
      set.  For the most part, everything set here is local to the current
      file.

      <P>

      One special variable set in the top-level <TT>Makefile.in</TT> is
      <TT>${SUBDIRS}</TT>.  This is the list of all subdirectories of the
      top source tree directory where compiling needs to be done.  It is used
      in doing recursive calls to <I>make</I>(1).  These recursive calls to
      <I>make</I>(1) are handled wherever other subdirectories exist--not
      just at the top level.  Presently, the other locations where similar
      code exists are in the <TT>Input</TT>, <TT>test</TT> and
      <TT>test/ogl</TT> directories.

      <P>

      A final special tag is <TT>@SET_MAKE@</TT>.  This is inserted here in
      case <I>make</I>(1) does not set <TT>${MAKE}</TT> when it runs.  This
      check is performed by <I>configure</I>, and a macro telling it to do
      this check is in <TT>configure.in</TT>.

      <P>
  <DT><B>Library targets</B>
    <DD>
      <P>

      These build targets are where the bulk of the work in compiling the
      library is done.  In the case when recursive calls to <I>make</I>(1)
      are not necessary, the structure in all <TT>Makefile.in</TT> files is
      the same.  First, the <B>default</B> target is set and then any
      remaining targets are defined.  Each file listed in the object file
      list defined prior to this point (including all files that may be
      compiled conditionally) must have a separate line giving the compile
      line for it.  The only dependency needed is the C/C++ source file
      associated with the object file.  Because <TT>${VPATH}</TT> is being
      used, the path to that source file is not needed.  However, in the
      compile line, a path must be given.  The <TT>${VJ_SRCDIR}</TT> variable
      is used so that some flexibility is available at configuration time.
      Though it is not currently implemented, it could be possible to use
      either an absolute path (using <TT>${VJROOT_ABS}</TT>) or a relative
      path (using <TT>${srcdir}</TT>).  This would be implemented in
      <TT>configure.in</TT>, and <TT>${VJ_SRCDIR}</TT> would simply have the
      current value substituted by <I>configure</I>.  Obviously, these
      targets are specific to the given <TT>Makefile</TT>.

      <P>

      Standard suffix rules for compiling <TT>.c</TT> and <TT>.C</TT> source
      files into object files are given, but they are not currently used
      because they do not work.  They fail because <I>make</I>(1) looks in
      the current directory for source files to compile, and when the source
      files are found in another directory (<TT>${srcdir}</TT> to be exact),
      the suffix rules cannot find them, even when <TT>${VPATH}</TT> is set.
      Why <I>make</I>(1) is implemented in this way is unclear.

      <P>

      For those cases when recursive calls to <I>make</I>(1) are required,
      a standard model is used.  The recursive targets are named in such a
      way that they have ``-recursive'' appended to the non-recursive name.
      For example, if the user entered <TT><B>make ddso</B></TT> and a
      recursive ddso build was necessary, the <TT>Makefile.in</TT> would have
      the following:

<PRE>
  ddso-recursive:
	<I>Some iterative shell code that recursively calls `<TT>${MAKE} ddso</TT>'</I>

  ddso: ddso-recursive
</PRE>

      The ``iterative shell code'' is the same in all files where it is used.
      The only difference is which targets use it.  The code loops over each
      directory name listed in <TT>${SUBDIRS}</TT>, changes into it, and runs
      whichever target was called.  This is where <TT>${OPTIMIZER}</TT> and
      <TT>${OBJDIR}</TT> are overridden to use the value appropriate to the
      build being done.

      <P>

      Finally, the <B>depend</B> and <B>newdepend</B> targets are defined for
      generating dependencies for all the source files given.  The
      <B>depend</B> target is built every time the user runs <I>make</I>(1)
      from the top-level directory, and thus it is dependent upon a file
      called <TT>.depend_done</TT> existing in the current subdirectory.  If
      it is necessary to regenerate the dependency list, <B>newdepend</B>
      can be run.  It removes <TT>.depend_done</TT> and then does a
      <TT><B>make depend</B></TT> in the current subdirectory.  These are
      exactly the same in all <TT>Makefile.in</TT> files (where they are
      needed) through the use of the <TT>${srcdir}</TT> and
      <TT>${WORKDIR}</TT> variables defined at the top of the file.

      <P>
  <DT><B>Local targets</B>
    <DD>
      <P>

      These targets are for any source files that are not compiled into the
      library but are (for example) used as test code.  This is one example
      of a time when it may be convenient to compile code in the current
      directory rather than in a common object file directory.  Generally,
      these targets will be similar to the library targets.  However,
      <I>makedepend</I>(1) is not run on these files.  A local target for
      doing this could be defined in the same manner as the common
      <B>depend</B> and <B>newdepend</B> targets though.

      <P>
  <DT><B>Clean-up targets</B>
    <DD>
      <P>

      A simple <B>clean</B> target is defined here in most
      <TT>Makefile.in</TT> files.  In those where recursive calls to
      <I>make</I>(1) are made, a recursive version is implemented.  As usual,
      these targets just remove any files that are not needed when done
      compiling.

      <P>
  <DT><B>Dependencies</B>
    <DD>
      <P>

      Most <TT>Makefile.in</TT> files end with an area where all the source
      dependencies are appended when the <B>depend</B> and <B>newdepend</B>
      targets are built.  The line marking this section must remain intact
      so that <I>makedepend</I>(1) will know where it is safe to begin
      overwriting the dependencies should it be run again.  This line is:

<PRE>
  # DO NOT DELETE THIS LINE -- make depend depends on it.
</PRE>

      It is the default string recognized by <I>makedepend</I>(1), but it can
      be changed by specifying an alternate string as an argument to
      <I>makedepend</I>(1).
</DL>

<HR WIDTH="80%" NOSHADE>
<P>

<H2>References</H2>

<DL>
  <DT><B>GNU Autoconf 2.12 Documentation</B>
    <DD>
      <P>

      The documentation comes with the Autoconf distribution and can be
      converted into HTML format.  It is very comprehensive but also very
      long.  On the ICEMT SGI workstations, the <TT>autoconf.info</TT> file
      is located in <TT>/usr/local/info</TT>.  The documentation in HTML
      format is in <TT>~patrick/docs/autoconf</TT>.
</DL>

<HR WIDTH="80%" NOSHADE>
<P>

<FONT SIZE="-1">
<B>Last modified:</B> $Date$<BR>
<B>Written by:</B> Patrick Hartling
&lt;<I><A HREF="mailto:patrick@icemt.iastate.edu">patrick@icemt.iastate.edu</A></I>&gt;<BR>
</FONT>

</BODY>

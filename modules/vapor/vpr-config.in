#!/usr/bin/env perl

# ***************** <VPR heading BEGIN do not edit this line> *****************
#
# VR Juggler Portable Runtime
#
# Original Authors:
#   Allen Bierbaum, Patrick Hartling, Kevin Meinert, Carolina Cruz-Neira
#
# -----------------------------------------------------------------
# File:          $RCSfile$
# Date modified: $Date$
# Version:       $Revision$
# -----------------------------------------------------------------
#
# ****************** <VPR heading END do not edit this line> ******************

# ************** <auto-copyright.pl BEGIN do not edit this line> **************
#
# VR Juggler is (C) Copyright 1998-2006 by Iowa State University
#
# Original Authors:
#   Allen Bierbaum, Christopher Just,
#   Patrick Hartling, Kevin Meinert,
#   Carolina Cruz-Neira, Albert Baker
#
# This library is free software; you can redistribute it and/or
# modify it under the terms of the GNU Library General Public
# License as published by the Free Software Foundation; either
# version 2 of the License, or (at your option) any later version.
#
# This library is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# Library General Public License for more details.
#
# You should have received a copy of the GNU Library General Public
# License along with this library; if not, write to the
# Free Software Foundation, Inc., 59 Temple Place - Suite 330,
# Boston, MA 02111-1307, USA.
#
# *************** <auto-copyright.pl END do not edit this line> ***************

use 5.004;

use strict 'vars';
use vars qw($ECHO_CXXFLAGS $ECHO_EXEC_PREFIX $ECHO_EXTRA_LIBS $ECHO_LIBS
            $ECHO_PREFIX);
use vars qw($exec_prefix $EXEC_PREFIX_SET $prefix $PREFIX_SET $LIBBITSUF
            $PLATFORM $VPR_ABI_FLAGS $VPR_ISA_FLAGS $Win32);

use File::Basename;
use Getopt::Long;

sub usage($);
sub normalizePath($);
sub make_CXXFLAGS($);
sub make_INCLUDES($);
sub make_LDFLAGS($;$$$);
sub make_EXTRA_LDFLAGS($;$);
sub handleOptArg($$);

# TODO: Do not use @prefix@ if possible.

usage(1) if $#ARGV == -1;

my $vpr_default_abi = qq(@ABI@);
my $vpr_default_isa = qq(@ISA@);
my $vpr32_flags     = qq(@vpr32_flags@);
my $vpr64_flags     = qq(@vpr64_flags@);
$LIBBITSUF          = qq(@LIBBITSUF@);
$PLATFORM           = qq(@PLATFORM@);

my $use_gcc = '@USE_GCC@';

$VPR_ABI_FLAGS = '';

# The default ABI is IRIX N32 or the default ISA is i386.
if ( $vpr_default_abi =~ /32$/i || "$vpr_default_isa" eq 'i386' )
{
   $VPR_ABI_FLAGS = "$vpr32_flags";
}
# The default ABI or ISA is 64-bit.
elsif ( "$vpr_default_abi" eq '64' || "$vpr_default_isa" eq 'x86_64' )
{
   $VPR_ABI_FLAGS = "$vpr64_flags";
}

$VPR_ISA_FLAGS = '';

# If we are not using GCC and a known ISA is defined, add define the ISA
# argument for the compiler and linker.
if ( $use_gcc !~ /^y/i && $vpr_default_isa =~ /^mips[34]/ )
{
   $VPR_ISA_FLAGS = "-$vpr_default_isa";
}

# Set up variables used to determine what the real prefix is.  This is
# important when this script has been installed.
$Win32 = (defined($ENV{'OS'}) && $ENV{'OS'} =~ /^win/i);

# Set the location of the collection of dependencies.  If $VJ_DEPS_DIR is
# not defined, then $deps_dir will be an empty string.  If the dependencies
# are installed in $VPR_BASE_DIR, then the user gets the right compiler and
# linker path options for free.  Otherwise, it is up to the user to provide
# those paths.
my $deps_dir = "$ENV{'VJ_DEPS_DIR'}" if defined("$ENV{'VJ_DEPS_DIR'}");

# Get the directory where this script is located.
my $base_dir = (fileparse("$0"))[1];

# If we are on Windows and $base_dir contains \'s, set $path_sep to \.
# Otherwise, we use / for the path separator.
my $path_sep = (($Win32 && $base_dir =~ /\\/) ? "\\" : "/");

$base_dir =~ s|${path_sep}+$||o;     # Strip off the trailing slash(es)
$base_dir =~ s|${path_sep}+bin$||io; # If the path ends in "/bin", strip it

# Strip extra slashes from $base_dir.
normalizePath(\$base_dir);

# If we are on Windows, make sure that $base_dir is a full DOS path.
if ( $Win32  && $base_dir !~ /^[A-Za-z]:/ )
{
   chomp($base_dir = `cygpath -w $base_dir`);
   $base_dir =~ s|\\|/|g;   # We want / as the path separator
}

# $exec_prefix may refer to $prefix, so it must be set after $prefix is
# defined.
$prefix      = "$base_dir";
$exec_prefix = qq(@exec_prefix@);

$ECHO_PREFIX      = 0;
$ECHO_EXEC_PREFIX = 0;
$PREFIX_SET       = 0;
$EXEC_PREFIX_SET  = 0;
$ECHO_CXXFLAGS    = 0;
$ECHO_LIBS        = 0;
$ECHO_EXTRA_LIBS  = 0;

my $script_help    = 0;
my $print_min      = 0;
my $echo_includes  = 0;
my $echo_subsystem = 0;
my $echo_version   = 0;
my $echo_static    = 0;
my $echo_profiled  = 0;
my $use_linker     = 0;

my $cxxflags_arg   = '';
my $libs_arg       = '';
my $extra_libs_arg = '';

GetOptions('help|?' => \$script_help, 'min' => \$print_min,
           'version' => \$echo_version, 'subsystem' => \$echo_subsystem,
           'prefix:s' => \&handleOptArg, 'exec-prefix:s' => \&handleOptArg,
           'cxxflags:s' => \&handleOptArg, 'includes' => \$echo_includes,
           'libs:s' => \&handleOptArg, 'extra-libs:s' => \&handleOptArg,
           'linker' => \$use_linker, 'static' => \$echo_static,
           'profiled' => \$echo_profiled);

usage(0) if $script_help;

# Print out the requested information.
print "$prefix\n" if $ECHO_PREFIX;
print "$exec_prefix\n" if $ECHO_EXEC_PREFIX;
print "@SUBSYSTEM@\n" if $echo_subsystem;
print "@MAJOR_VERSION@.@MINOR_VERSION@.@MICRO_VERSION@\n" if $echo_version;

if ( $ECHO_CXXFLAGS || $echo_includes )
{
   my $cxxflags = make_CXXFLAGS("$cxxflags_arg");
   my $includes = make_INCLUDES("$cxxflags");
   print "$cxxflags\n" if $ECHO_CXXFLAGS;
   print "$includes\n" if $echo_includes;
}

if ( $ECHO_LIBS )
{
   my $ldflags = make_LDFLAGS("$libs_arg", $echo_static, $echo_profiled,
                              $use_linker);
   print "$ldflags\n";
}

if ( $ECHO_EXTRA_LIBS )
{
   my $extra_ldflags = make_EXTRA_LDFLAGS("$extra_libs_arg", $use_linker);
   print "$extra_ldflags\n";
}

exit(0);

# =============================================================================
# Subroutines follow.
# =============================================================================

sub usage ($)
{
    print <<EOF;
Usage: $0 [OPTIONS] [LIBRARIES]
Options:
        [--prefix[=DIR]]        Print the installation prefix or set an
                                alternate prefix to use when printing paths
        [--exec-prefix[=DIR]]   Print the executable prefix or set an
                                alternate executable prefix to use when
                                printing paths
        [--version]             Print the installed VPR's version number
        [--cxxflags [32|64]]    Print the VPR-specific flags for the C++
                                compiler
        [--includes]            Print out only the header path extension
                                arguments
        [--libs [32|64]]        Print the basic VPR-specific libraries
        [--extra-libs [32|64]]  Print the extra linker options needed for
                                making an executable
        [--linker]              Print libraries as direct arguments to the
                                linker rather than to the compiler
        [--static]              Print the library arguments using static
                                linking flags
        [--profiled]            Print the profiled library names
        [--subsystem]           Print the OS abstraction layer being used
EOF

    exit($_[0]);
}

sub normalizePath($)
{
   my $path_ref = shift;

   # If we are on Windows and $base_dir contains \'s, set $path_sep to \.
   # Otherwise, we use / for the path separator.
   my $path_sep = (($Win32 && $$path_ref =~ /\\/) ? "\\" : "/");

   while ( $$path_ref =~ m|${path_sep}{2,}|o )
   {
      $$path_ref =~ s|${path_sep}{2,}|${path_sep}|go;
   }

   $$path_ref =~ s|${path_sep}+$||go;
}

sub make_CXXFLAGS ($)
{
   my $cxxflags_arg = shift;

   my $cxxflags = '';

   # Default setting from configure.
   my $vpr_extra_cxxflags = qq(@vpr_extra_cxxflags@);

   if ( $cxxflags_arg =~ /32$/i )
   {
      $vpr_extra_cxxflags = "$vpr_extra_cxxflags $vpr32_flags $VPR_ISA_FLAGS";
   }
   elsif ( "$cxxflags_arg" eq '64' )
   {
      $vpr_extra_cxxflags = "$vpr_extra_cxxflags $vpr64_flags $VPR_ISA_FLAGS";
   }
   elsif ( "$cxxflags_arg" eq '' )
   {
      $vpr_extra_cxxflags = "$vpr_extra_cxxflags $VPR_ABI_FLAGS $VPR_ISA_FLAGS";
   }

   my $vpr_extra_includes = '';

   # XXX: This is pretty lame, but I cannot think of a better way to ensure
   # that this extra directory is added when it is needed.
   if ( "$PLATFORM" eq "IRIX" )
   {
      my $hack_deps_dir = ("$deps_dir" ne "" ? "$deps_dir" : "$base_dir");
      $vpr_extra_includes = "-I$hack_deps_dir/include/boost/compatibility/cpp_c_headers";
   }

   $cxxflags = qq(@vpr_cxxflags@ $vpr_extra_cxxflags @subsystem_cxxflags@ ) .
               qq(-I@includedir@ $vpr_extra_includes);

   $cxxflags .= " -I$deps_dir/include" if $deps_dir;

   # Strip out extra whitespace.
   $cxxflags =~ s/\s{2,}/ /g;

   return "$cxxflags";
}

sub make_INCLUDES ($)
{
   my(@compiler_flags) = split(/\s+/, "$_[0]");
   return join(" ", grep(/^-I/, @compiler_flags));
}

sub make_LDFLAGS ($;$$$)
{
   my $libs_arg      = shift;
   my $echo_static   = shift || 0;  # Echo static linking flags
   my $echo_profiled = shift || 0;  # Echo profiled library
   my $use_linker    = shift || 0;  # Use flags for direct use of the linker

   my $static_begin = '';
   my $static_end   = '';

   if ( $echo_static )
   {
      $static_begin = qq(@static_begin@);
      $static_end   = qq(@static_end@);
   }

   my $ldflags = '';

   if ( $libs_arg =~ /32$/i )
   {
      $ldflags   = "$vpr32_flags $VPR_ISA_FLAGS";
      $LIBBITSUF = ("$PLATFORM" eq 'IRIX' ? '32' : '');
   }
   elsif ( "$libs_arg" eq '64' )
   {
      $ldflags   = "$vpr64_flags $VPR_ISA_FLAGS";
      $LIBBITSUF = '64';
   }
   elsif ( "$libs_arg" eq '' )
   {
      $ldflags = "$VPR_ABI_FLAGS $VPR_ISA_FLAGS";
   }

   $ldflags .= ($use_linker ? qq( @vpr_ldflags_linker@)
                            : qq( @vpr_ldflags_compiler@));

   my $vpr_libs     = ($echo_profiled ? qq(@vpr_prof_libs@) : qq(@vpr_libs@));
   my $full_ldflags = "$ldflags $static_begin $vpr_libs $static_end";
   $full_ldflags    =~ s/\s{2,}/ /g;

   return "$full_ldflags";
}

sub make_EXTRA_LDFLAGS ($;$)
{
   my $extra_libs_arg = shift;
   my $use_linker     = shift || 0;

   if ( $extra_libs_arg =~ /32$/i )
   {
      $LIBBITSUF = ("$PLATFORM" eq 'IRIX' ? '32' : '');
   }
   elsif ( "$extra_libs_arg" eq '64' )
   {
      $LIBBITSUF = '64';
   }

   my $subsystem_libs    = qq(@subsystem_libs@);
   my $my_subsystem_libs = '';

   my $arg;
   foreach $arg ( split(/\s+/, "$subsystem_libs") )
   {
      $my_subsystem_libs .= " $arg" unless "$arg" eq qq(-L@libdir@);
   }

   my $extra_ldflags = ($use_linker ? qq(@vpr_extra_ldflags_linker@)
                                    : qq(@vpr_extra_ldflags_compiler@));
   $extra_ldflags    = "-L$deps_dir/lib$LIBBITSUF $extra_ldflags" if $deps_dir;

   my $full_extra_ldflags = qq($extra_ldflags @vpr_extra_libs@ ) .
                            "$my_subsystem_libs";
   $full_extra_ldflags    =~ s/\s{2,}/ /g;

   return "$full_extra_ldflags";
}

# Subroutine for handling command-line parameters that have an optional
# argument.
sub handleOptArg ($$)
{
   my $name  = shift;
   my $value = shift || '';

   SWITCH:
   {
      if ( "$name" eq "prefix" )
      {
         # If $value is defined, we set $prefix to its value.  The value of
         # $prefix will not be printed in this case.
         if ( $value )
         {
            $prefix      = "$value";
            $ECHO_PREFIX = 0;
            $PREFIX_SET  = 1;
         }
         # If $value is undefined, that means that --prefix was specified, but
         # no value was given.  In that case, we just want to print the
         # prefix.
         else
         {
            $ECHO_PREFIX = 1;
         }

         last SWITCH;
      }

      if ( "$name" eq "exec-prefix" )
      {
         # If $value is defined, we set $exec_prefix to its value.  The value
         # of $exec_prefix will not be printed in this case.
         if ( $value )
         {
            $exec_prefix      = "$value";
            $EXEC_PREFIX_SET  = 1;
            $ECHO_EXEC_PREFIX = 0;
         }
         # If $value is undefined, that means that --exec-prefix was specified,
         # but no value was given.  In that case, we just want to print the
         # exec prefix.
         else
         {
            $ECHO_EXEC_PREFIX = 1;
         }

         last SWITCH;
      }

      if ( "$name" eq "cxxflags" )
      {
         $ECHO_CXXFLAGS = 1;
         $cxxflags_arg  = $value;
         last SWITCH;
      }

      if ( "$name" eq "libs" )
      {
         $ECHO_LIBS = 1;
         $libs_arg  = $value;
         last SWITCH;
      }

      if ( "$name" eq "extra-libs" )
      {
         $ECHO_EXTRA_LIBS = 1;
         $extra_libs_arg  = $value;
         last SWITCH;
      }
   }
}
